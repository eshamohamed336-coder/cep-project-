<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>College Events | Student Portal</title>
        <!-- Google Fonts -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link
            href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=Space+Grotesk:wght@300;400;500;600;700&display=swap"
            rel="stylesheet">
        <link rel="stylesheet" href="static/css/style.css">
        <!-- Ionicons -->
        <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
        <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
        <script src="static/js/animations.js" defer></script>
        <style>
            /* Specific Student Styles */
            .dept-filter-container {
                margin: 2rem 10% 0;
                display: flex;
                align-items: center;
                gap: 1rem;
                flex-wrap: wrap;
            }

            .dept-select {
                padding: 8px 16px;
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.2);
                border-radius: 20px;
                color: white;
                font-family: inherit;
            }

            /* Modal Styles */
            .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(5px);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 2000;
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.3s ease;
            }

            .modal-overlay.open {
                opacity: 1;
                pointer-events: all;
            }

            .modal-content {
                background: #111;
                border: 1px solid rgba(255, 255, 255, 0.1);
                padding: 2rem;
                border-radius: 20px;
                width: 90%;
                max-width: 400px;
                transform: scale(0.9);
                transition: transform 0.3s ease;
            }

            .modal-overlay.open .modal-content {
                transform: scale(1);
            }

            .modal-content input {
                width: 100%;
                padding: 10px;
                margin-bottom: 1rem;
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid #333;
                color: white;
                border-radius: 5px;
            }

            .close-modal {
                float: right;
                cursor: pointer;
                font-size: 1.5rem;
            }
        </style>
    </head>

    <body>
        <nav class="navbar">
            <div class="logo">College <span class="highlight">Events</span> <span
                    style="font-size:0.8rem; color:#888;">STUDENT</span></div>
            <ul class="nav-links">
                <li><a href="#events">Events</a></li>
                <li><a href="index.html">Logout</a></li>
            </ul>
            <div class="hamburger">
                <ion-icon name="menu-outline"></ion-icon>
            </div>
        </nav>

        <!-- Header section reused but simplified -->
        <header class="hero" style="min-height: 50vh; padding-top: 100px;">
            <div class="hero-content reveal">
                <h1>Discover <span class="gradient-text">Events</span></h1>
                <p>Filter by your department or category to find what suits you.</p>
            </div>
        </header>

        <div class="dept-filter-container">
            <label>Select Department:</label>
            <select id="deptFilter" class="dept-select">
                <option value="all">All Departments</option>
                <option value="BCA">BCA</option>
                <option value="B.Sc CS">B.Sc CS</option>
                <option value="B.Sc IT">B.Sc IT</option>
                <option value="B.Com">B.Com</option>
                <option value="BBA">BBA</option>
                <option value="VisCom">VisCom</option>
                <option value="B.Sc Physics">B.Sc Physics</option>
            </select>
        </div>

        <section id="events" class="section">
            <div class="section-header reveal">
                <h2>Events</h2>
                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="technical">Technical</button>
                    <button class="filter-btn" data-filter="non-technical">Non-Technical</button>
                </div>
            </div>

            <div class="events-grid" id="eventsGrid">
                <!-- Driven by JS -->
            </div>
        </section>

        <!-- Registration Modal -->
        <div class="modal-overlay" id="regModal">
            <div class="modal-content">
                <span class="close-modal" onclick="closeModal()">&times;</span>
                <h2 style="margin-bottom:1rem;">Register</h2>
                <p id="regEventTitle" style="color:#888; margin-bottom:1rem;"></p>
                <form id="regForm">
                    <input type="text" id="regName" placeholder="Full Name" required>
                    <input type="text" id="regRoll" placeholder="Roll Number" required>
                    <input type="text" id="regDept" placeholder="Department" required>
                    <button type="submit" class="btn-primary" style="width:100%">Confirm Registration</button>
                </form>
            </div>
        </div>

        <script src="static/js/eventManager.js"></script>
        <script>
            const grid = document.getElementById('eventsGrid');
            const deptFilter = document.getElementById('deptFilter');
            const filterBtns = document.querySelectorAll('.filter-btn');
            let currentCategory = 'all';
            let currentDept = 'all';

            // Initial Load
            async function renderEvents() {
                const events = await EventManager.getEvents();
                grid.innerHTML = '';

                const filtered = events.filter(e => {
                    const catMatch = currentCategory === 'all' || e.category === currentCategory;
                    const deptMatch = currentDept === 'all' || e.department === currentDept || e.department === 'All';
                    return catMatch && deptMatch;
                });

                if (filtered.length === 0) {
                    grid.innerHTML = '<p style="color:#888; width:100%;">No events found for this selection.</p>';
                    return;
                }

                filtered.forEach((e, index) => {
                    const card = document.createElement('div');
                    card.className = 'event-card hover-lift';
                    card.style.animation = `slideUpFade 0.5s ease-out forwards ${index * 0.1}s`;
                    card.style.opacity = '0';

                    // Determine cover style (image vs gradient)
                    const coverStyle = e.image ? `background-image: url(${e.image}); background-size: cover; background-position: center;` : '';
                    const coverClass = e.image ? '' : (e.bgClass || 'tech-bg');

                    card.innerHTML = `
                    <div class="card-image ${coverClass}" style="${coverStyle}">
                        <span class="category-tag">${e.department}</span>
                    </div>
                    <div class="card-content">
                        <div class="date"><ion-icon name="calendar-outline"></ion-icon> ${e.date}</div>
                        <h3>${e.title}</h3>
                        <p>${e.description}</p>
                        <div class="card-footer">
                            <span class="location"><ion-icon name="location-outline"></ion-icon> ${e.location}</span>
                            <button class="btn-link" onclick="openModal('${e.id}', '${e.title}')" style="background:none; border:none; cursor:pointer;">Register <ion-icon name="arrow-forward-outline"></ion-icon></button>
                        </div>
                    </div>
                `;
                    grid.appendChild(card);
                });
            }

            // Event Listeners for Filters
            deptFilter.addEventListener('change', (e) => {
                currentDept = e.target.value;
                renderEvents();
            });

            filterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    filterBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentCategory = btn.getAttribute('data-filter');
                    renderEvents();
                });
            });

            // Modal Logic
            const modal = document.getElementById('regModal');
            let currentEventId = null;

            window.openModal = (id, title) => {
                currentEventId = id;
                document.getElementById('regEventTitle').innerText = title;
                modal.classList.add('open');
            }

            window.closeModal = () => {
                modal.classList.remove('open');
            }

            document.getElementById('regForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('regName').value;
                const roll = document.getElementById('regRoll').value;

                await EventManager.registerStudent(name, roll, currentEventId);

                alert('Registration Successful! Information has been recorded.');

                // Redirect to WhatsApp
                const whatsappNumber = "918056823617";
                const message = encodeURIComponent(`Hi, I am ${name} (Roll: ${roll}). I just registered for the event: ${document.getElementById('regEventTitle').innerText}.`);
                window.location.href = `https://api.whatsapp.com/send?phone=${whatsappNumber}&text=${message}`;

                closeModal();
                document.getElementById('regForm').reset();
            });

            // Init
            renderEvents();
        </script>
    </body>

</html>